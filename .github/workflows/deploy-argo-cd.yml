name: Deploy ArgoCD

on:
  push:
    branches: [ main ]
    paths: [ 'argo-cd/my-values.yaml' ]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  EKS_CLUSTER_NAME: bluesunnywings-eks

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Update kubeconfig
      run: aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME
    
    - name: Install Helm
      uses: azure/setup-helm@v4
    
    - name: Create namespace
      run: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy ArgoCD
      run: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo update
        helm upgrade --install argocd argo/argo-cd \
        --version 7.7.17 \
        -n argocd \
        -f argo-cd/my-values.yaml \
        --wait --timeout=10m
