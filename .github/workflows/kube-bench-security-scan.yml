name: ğŸ”’ Kube-bench EKS Security Scan

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST ê¸°ì¤€ ì˜¤ì „ 6ì‹œ UTC)ì— ì‹¤í–‰
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'EKS í´ëŸ¬ìŠ¤í„° ì´ë¦„'
        required: false
        default: 'bluesunnywings-eks'
      severity_threshold:
        description: 'ì•Œë¦¼ ì„ê³„ê°’ (CRITICAL, HIGH, MEDIUM, LOW)'
        required: false
        default: 'HIGH'
        type: choice
        options:
          - CRITICAL
          - HIGH
          - MEDIUM
          - LOW

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

env:
  CLUSTER_NAME: ${{ github.event.inputs.cluster_name || 'bluesunnywings-eks' }}
  SEVERITY_THRESHOLD: ${{ github.event.inputs.severity_threshold || 'HIGH' }}

jobs:
  kube-bench-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'ap-northeast-2' }}

    - name: ğŸ”§ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: ğŸ”§ Update kubeconfig
      run: |
        aws eks update-kubeconfig --region ${{ secrets.AWS_REGION || 'ap-northeast-2' }} --name ${{ env.CLUSTER_NAME }}
        kubectl cluster-info

    - name: ğŸ” Run Kube-bench Security Scan
      id: kube_bench_scan
      run: |
        # íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„± (ê³ ìœ í•œ Job ì´ë¦„ì„ ìœ„í•´, RFC 1123 í˜¸í™˜)
        TIMESTAMP_FILE=$(date +"%Y%m%d_%H%M%S")  # íŒŒì¼ëª…ìš© (ë°‘ì¤„ ì‚¬ìš© ê°€ëŠ¥)
        TIMESTAMP_K8S=$(date +"%Y%m%d-%H%M%S")   # Kubernetes ë¦¬ì†ŒìŠ¤ëª…ìš© (í•˜ì´í”ˆë§Œ ì‚¬ìš©)
        RANDOM_SUFFIX=$(shuf -i 1000-9999 -n 1)
        JOB_NAME="kube-bench-eks-scan-${TIMESTAMP_K8S}-${RANDOM_SUFFIX}"
        
        echo "timestamp=$TIMESTAMP_FILE" >> $GITHUB_OUTPUT
        echo "job_name=$JOB_NAME" >> $GITHUB_OUTPUT
        
        # ê¸°ì¡´ kube-bench Jobë“¤ ì •ë¦¬ (ì¶©ëŒ ë°©ì§€)
        echo "ğŸ§¹ Cleaning up old kube-bench jobs..."
        kubectl get jobs -o name | grep "kube-bench-eks-scan" | xargs -r kubectl delete --ignore-not-found=true
        echo "âœ… Old jobs cleaned up"
        
        # kube-bench Job ì‹¤í–‰
        echo "ğŸš€ Starting kube-bench security scan with job name: $JOB_NAME"
        
        # EKSìš© kube-bench Job ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± (ê³ ìœ í•œ ì´ë¦„ ì‚¬ìš©)
        cat > kube-bench-job.yaml << EOF
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: $JOB_NAME
          namespace: default
          labels:
            app: kube-bench
            scan-type: security
            created-by: github-actions
            timestamp: "$TIMESTAMP_K8S"
        spec:
          template:
            metadata:
              labels:
                app: kube-bench
                scan-type: security
            spec:
              hostPID: true
              nodeSelector:
                kubernetes.io/os: linux
              tolerations:
              - key: node-role.kubernetes.io/master
                operator: Exists
                effect: NoSchedule
              containers:
              - name: kube-bench
                image: aquasec/kube-bench:latest
                command: ["kube-bench"]
                args: ["--benchmark", "eks-1.0.1", "--json"]
                volumeMounts:
                - name: var-lib-etcd
                  mountPath: /var/lib/etcd
                  readOnly: true
                - name: var-lib-kubelet
                  mountPath: /var/lib/kubelet
                  readOnly: true
                - name: var-lib-kube-scheduler
                  mountPath: /var/lib/kube-scheduler
                  readOnly: true
                - name: var-lib-kube-controller-manager
                  mountPath: /var/lib/kube-controller-manager
                  readOnly: true
                - name: etc-systemd
                  mountPath: /etc/systemd
                  readOnly: true
                - name: lib-systemd
                  mountPath: /lib/systemd/
                  readOnly: true
                - name: srv-kubernetes
                  mountPath: /srv/kubernetes/
                  readOnly: true
                - name: etc-kubernetes
                  mountPath: /etc/kubernetes
                  readOnly: true
                - name: usr-bin
                  mountPath: /usr/local/mount-from-host/bin
                  readOnly: true
                - name: etc-cni-netd
                  mountPath: /etc/cni/net.d/
                  readOnly: true
                - name: opt-cni-bin
                  mountPath: /opt/cni/bin/
                  readOnly: true
              restartPolicy: Never
              volumes:
              - name: var-lib-etcd
                hostPath:
                  path: "/var/lib/etcd"
              - name: var-lib-kubelet
                hostPath:
                  path: "/var/lib/kubelet"
              - name: var-lib-kube-scheduler
                hostPath:
                  path: "/var/lib/kube-scheduler"
              - name: var-lib-kube-controller-manager
                hostPath:
                  path: "/var/lib/kube-controller-manager"
              - name: etc-systemd
                hostPath:
                  path: "/etc/systemd"
              - name: lib-systemd
                hostPath:
                  path: "/lib/systemd"
              - name: srv-kubernetes
                hostPath:
                  path: "/srv/kubernetes"
              - name: etc-kubernetes
                hostPath:
                  path: "/etc/kubernetes"
              - name: usr-bin
                hostPath:
                  path: "/usr/bin"
              - name: etc-cni-netd
                hostPath:
                  path: "/etc/cni/net.d/"
              - name: opt-cni-bin
                hostPath:
                  path: "/opt/cni/bin/"
          backoffLimit: 2
        EOF
        
        # Job ì‹¤í–‰
        kubectl apply -f kube-bench-job.yaml
        
        # Job ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
        echo "â³ Waiting for kube-bench scan to complete..."
        kubectl wait --for=condition=complete --timeout=600s job/$JOB_NAME
        
        # Job ìƒíƒœ í™•ì¸
        JOB_STATUS=$(kubectl get job $JOB_NAME -o jsonpath='{.status.conditions[0].type}')
        if [ "$JOB_STATUS" != "Complete" ]; then
          echo "âŒ Job failed or timed out"
          kubectl describe job $JOB_NAME
          kubectl logs job/$JOB_NAME
          exit 1
        fi
        
        # ê²°ê³¼ ìˆ˜ì§‘
        echo "ğŸ“Š Collecting scan results..."
        kubectl logs job/$JOB_NAME > kube-bench-results-${TIMESTAMP_FILE}.json
        
        # Job ì •ë¦¬
        echo "ğŸ§¹ Cleaning up job $JOB_NAME"
        kubectl delete job $JOB_NAME
        
        echo "âœ… Kube-bench scan completed successfully"

    - name: ğŸ“Š Process Scan Results
      id: process_results
      run: |
        TIMESTAMP=${{ steps.kube_bench_scan.outputs.timestamp }}
        RESULTS_FILE="kube-bench-results-${TIMESTAMP}.json"
        
        python3 << 'EOF'
        import json
        import os
        import sys
        from datetime import datetime
        
        timestamp = os.environ['TIMESTAMP']
        results_file = f"kube-bench-results-{timestamp}.json"
        
        try:
            with open(results_file, 'r') as f:
                content = f.read()
            
            # JSON íŒŒì‹± ì‹œë„
            try:
                results = json.loads(content)
            except json.JSONDecodeError:
                # JSONì´ ì•„ë‹Œ ê²½ìš° í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
                print("Results are not in JSON format, processing as text...")
                results = {"raw_output": content}
            
            # ê²°ê³¼ ë¶„ì„
            total_tests = 0
            passed_tests = 0
            failed_tests = 0
            warnings = 0
            
            critical_issues = []
            high_issues = []
            medium_issues = []
            low_issues = []
            
            if "Controls" in results:
                for control in results["Controls"]:
                    for test in control.get("tests", []):
                        for result in test.get("results", []):
                            total_tests += 1
                            
                            if result.get("test_result") == "PASS":
                                passed_tests += 1
                            elif result.get("test_result") == "FAIL":
                                failed_tests += 1
                                
                                # ì‹¬ê°ë„ ë¶„ë¥˜ (ì„ì‹œ ë¡œì§)
                                test_desc = result.get("test_desc", "").lower()
                                if any(keyword in test_desc for keyword in ["encryption", "tls", "certificate", "authentication"]):
                                    critical_issues.append(result)
                                elif any(keyword in test_desc for keyword in ["authorization", "rbac", "network", "firewall"]):
                                    high_issues.append(result)
                                elif any(keyword in test_desc for keyword in ["logging", "audit", "monitoring"]):
                                    medium_issues.append(result)
                                else:
                                    low_issues.append(result)
                            elif result.get("test_result") == "WARN":
                                warnings += 1
            
            # ìš”ì•½ ì •ë³´ ìƒì„±
            summary = {
                "timestamp": timestamp,
                "cluster_name": os.environ.get('CLUSTER_NAME', 'unknown'),
                "total_tests": total_tests,
                "passed_tests": passed_tests,
                "failed_tests": failed_tests,
                "warnings": warnings,
                "pass_rate": round((passed_tests / total_tests * 100) if total_tests > 0 else 0, 2),
                "critical_count": len(critical_issues),
                "high_count": len(high_issues),
                "medium_count": len(medium_issues),
                "low_count": len(low_issues)
            }
            
            # ìƒì„¸ ê²°ê³¼ ì €ì¥
            detailed_results = {
                "summary": summary,
                "critical_issues": critical_issues[:10],  # ìƒìœ„ 10ê°œë§Œ
                "high_issues": high_issues[:10],
                "medium_issues": medium_issues[:5],
                "low_issues": low_issues[:5],
                "raw_results": results
            }
            
            with open(f'kube-bench-analysis-{timestamp}.json', 'w') as f:
                json.dump(detailed_results, f, indent=2)
            
            # GitHub Actions ì¶œë ¥ ì„¤ì •
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"total_tests={total_tests}\n")
                f.write(f"failed_tests={failed_tests}\n")
                f.write(f"critical_count={len(critical_issues)}\n")
                f.write(f"high_count={len(high_issues)}\n")
                f.write(f"pass_rate={summary['pass_rate']}\n")
                f.write(f"has_critical={'true' if len(critical_issues) > 0 else 'false'}\n")
                f.write(f"has_high={'true' if len(high_issues) > 0 else 'false'}\n")
                f.write(f"needs_attention={'true' if (len(critical_issues) > 0 or len(high_issues) > 0) else 'false'}\n")
            
            print(f"âœ… Analysis completed:")
            print(f"   Total tests: {total_tests}")
            print(f"   Passed: {passed_tests}")
            print(f"   Failed: {failed_tests}")
            print(f"   Pass rate: {summary['pass_rate']}%")
            print(f"   Critical issues: {len(critical_issues)}")
            print(f"   High issues: {len(high_issues)}")
            
        except Exception as e:
            print(f"âŒ Error processing results: {e}")
            sys.exit(1)
        
        EOF
      env:
        TIMESTAMP: ${{ steps.kube_bench_scan.outputs.timestamp }}

    - name: ğŸ“‹ Generate Security Report
      id: generate_report
      run: |
        TIMESTAMP=${{ steps.kube_bench_scan.outputs.timestamp }}
        
        python3 << 'EOF'
        import json
        import os
        from datetime import datetime
        
        timestamp = os.environ['TIMESTAMP']
        
        # ë¶„ì„ ê²°ê³¼ ë¡œë“œ
        with open(f'kube-bench-analysis-{timestamp}.json', 'r') as f:
            analysis = json.load(f)
        
        summary = analysis['summary']
        
        # ë³´ê³ ì„œ ìƒì„±
        report = f"""# ğŸ”’ Kube-bench EKS ë³´ì•ˆ ê²€ì‚¬ ë³´ê³ ì„œ
        
        **ê²€ì‚¬ ì¼ì‹œ**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S KST')}
        **í´ëŸ¬ìŠ¤í„°**: {summary['cluster_name']}
        **ê²€ì‚¬ ID**: {timestamp}
        
        ## ğŸ“Š ê²€ì‚¬ ìš”ì•½
        
        | í•­ëª© | ìˆ˜ëŸ‰ | ë¹„ìœ¨ |
        |------|------|------|
        | ì „ì²´ í…ŒìŠ¤íŠ¸ | {summary['total_tests']} | 100% |
        | í†µê³¼ | {summary['passed_tests']} | {summary['pass_rate']}% |
        | ì‹¤íŒ¨ | {summary['failed_tests']} | {round((summary['failed_tests'] / summary['total_tests'] * 100) if summary['total_tests'] > 0 else 0, 2)}% |
        | ê²½ê³  | {summary['warnings']} | {round((summary['warnings'] / summary['total_tests'] * 100) if summary['total_tests'] > 0 else 0, 2)}% |
        
        ## ğŸš¨ ì‹¬ê°ë„ë³„ ì´ìŠˆ í˜„í™©
        
        | ì‹¬ê°ë„ | ê°œìˆ˜ | ìƒíƒœ |
        |--------|------|------|
        | ğŸ”´ Critical | {summary['critical_count']} | {'âš ï¸ ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”' if summary['critical_count'] > 0 else 'âœ… ì–‘í˜¸'} |
        | ğŸŸ  High | {summary['high_count']} | {'âš ï¸ ìš°ì„  ì¡°ì¹˜ í•„ìš”' if summary['high_count'] > 0 else 'âœ… ì–‘í˜¸'} |
        | ğŸŸ¡ Medium | {summary['medium_count']} | {'ğŸ“‹ ê²€í†  í•„ìš”' if summary['medium_count'] > 0 else 'âœ… ì–‘í˜¸'} |
        | ğŸŸ¢ Low | {summary['low_count']} | {'ğŸ“ ì°¸ê³ ' if summary['low_count'] > 0 else 'âœ… ì–‘í˜¸'} |
        
        ## ğŸ” ì£¼ìš” ë°œê²¬ ì‚¬í•­
        """
        
        # Critical ì´ìŠˆ ì¶”ê°€
        if analysis['critical_issues']:
            report += "\n### ğŸ”´ Critical ì´ìŠˆ\n\n"
            for i, issue in enumerate(analysis['critical_issues'][:5], 1):
                report += f"""**{i}. {issue.get('test_desc', 'Unknown test')}**
        - **í…ŒìŠ¤íŠ¸ ë²ˆí˜¸**: {issue.get('test_number', 'N/A')}
        - **ìƒíƒœ**: {issue.get('test_result', 'FAIL')}
        - **ì„¤ëª…**: {issue.get('remediation', 'ìˆ˜ì • ë°©ë²•ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')}
        
        """
        
        # High ì´ìŠˆ ì¶”ê°€
        if analysis['high_issues']:
            report += "\n### ğŸŸ  High ì´ìŠˆ\n\n"
            for i, issue in enumerate(analysis['high_issues'][:5], 1):
                report += f"""**{i}. {issue.get('test_desc', 'Unknown test')}**
        - **í…ŒìŠ¤íŠ¸ ë²ˆí˜¸**: {issue.get('test_number', 'N/A')}
        - **ìƒíƒœ**: {issue.get('test_result', 'FAIL')}
        - **ì„¤ëª…**: {issue.get('remediation', 'ìˆ˜ì • ë°©ë²•ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')}
        
        """
        
        report += f"""
        ## ğŸ“ˆ ë³´ì•ˆ ì ìˆ˜
        
        **ì „ì²´ ë³´ì•ˆ ì ìˆ˜**: {summary['pass_rate']}% ({'ğŸŸ¢ ìš°ìˆ˜' if summary['pass_rate'] >= 90 else 'ğŸŸ¡ ë³´í†µ' if summary['pass_rate'] >= 70 else 'ğŸ”´ ê°œì„  í•„ìš”'})
        
        ## ğŸ”§ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
        
        1. **ì¦‰ì‹œ ì¡°ì¹˜**: Critical ë° High ì‹¬ê°ë„ ì´ìŠˆ ìš°ì„  í•´ê²°
        2. **ì •ê¸° ê²€í† **: Medium ì‹¬ê°ë„ ì´ìŠˆì— ëŒ€í•œ ë³´ì•ˆ ì •ì±… ê²€í† 
        3. **ëª¨ë‹ˆí„°ë§**: ì§€ì†ì ì¸ ë³´ì•ˆ ê²€ì‚¬ ë° ëª¨ë‹ˆí„°ë§ ì²´ê³„ êµ¬ì¶•
        4. **ë¬¸ì„œí™”**: ë³´ì•ˆ ì„¤ì • ë³€ê²½ ì‚¬í•­ì— ëŒ€í•œ ë¬¸ì„œí™”
        
        ## ğŸ“Š ìƒì„¸ ê²°ê³¼
        
        <details>
        <summary>ìƒì„¸ ê²€ì‚¬ ê²°ê³¼ ë³´ê¸°</summary>
        
        ```json
        {json.dumps(analysis, indent=2, ensure_ascii=False)}
        ```
        
        </details>
        
        ---
        
        **ë‹¤ìŒ ê²€ì‚¬ ì˜ˆì •**: ë‚´ì¼ ì˜¤ì „ 9ì‹œ (KST)
        **ë³´ê³ ì„œ ìƒì„±**: GitHub Actions ìë™í™”
        """
        
        # ë³´ê³ ì„œ íŒŒì¼ ì €ì¥
        with open(f'security-report-{timestamp}.md', 'w', encoding='utf-8') as f:
            f.write(report)
        
        print("âœ… Security report generated successfully")
        
        EOF
      env:
        TIMESTAMP: ${{ steps.kube_bench_scan.outputs.timestamp }}

    - name: ğŸ“‹ Create GitHub Issue
      if: steps.process_results.outputs.needs_attention == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const timestamp = '${{ steps.kube_bench_scan.outputs.timestamp }}';
          
          // ë³´ê³ ì„œ ë‚´ìš© ì½ê¸°
          const reportContent = fs.readFileSync(`security-report-${timestamp}.md`, 'utf8');
          
          // ì´ìŠˆ ì œëª© ìƒì„±
          const criticalCount = '${{ steps.process_results.outputs.critical_count }}';
          const highCount = '${{ steps.process_results.outputs.high_count }}';
          const passRate = '${{ steps.process_results.outputs.pass_rate }}';
          
          let severity = 'ğŸŸ¡ MEDIUM';
          if (criticalCount > 0) severity = 'ğŸ”´ CRITICAL';
          else if (highCount > 0) severity = 'ğŸŸ  HIGH';
          
          const issueTitle = `${severity} Kube-bench ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ - ${new Date().toISOString().split('T')[0]} (í†µê³¼ìœ¨: ${passRate}%)`;
          
          // ê¸°ì¡´ ì´ìŠˆ ê²€ìƒ‰
          const { data: existingIssues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'kube-bench,security',
            state: 'open'
          });
          
          // ì˜¤ëŠ˜ ë‚ ì§œì˜ ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
          const today = new Date().toISOString().split('T')[0];
          const todayIssue = existingIssues.find(issue => 
            issue.title.includes(today)
          );
          
          if (todayIssue) {
            // ê¸°ì¡´ ì´ìŠˆì— ëŒ“ê¸€ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: todayIssue.number,
              body: `## ğŸ”„ ì—…ë°ì´íŠ¸ëœ ê²€ì‚¬ ê²°ê³¼\n\n${reportContent}`
            });
            
            console.log(`Updated existing issue #${todayIssue.number}`);
          } else {
            // ìƒˆ ì´ìŠˆ ìƒì„±
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: reportContent,
              labels: ['security', 'kube-bench', 'eks', 'automated']
            });
            
            console.log(`Created new issue #${newIssue.data.number}`);
          }

    - name: ğŸ“± Send Slack Notification
      if: always()
      run: |
        python3 << 'EOF'
        import json
        import requests
        import os
        
        # ê²°ê³¼ ì •ë³´ ìˆ˜ì§‘
        timestamp = '${{ steps.kube_bench_scan.outputs.timestamp }}'
        total_tests = '${{ steps.process_results.outputs.total_tests }}'
        failed_tests = '${{ steps.process_results.outputs.failed_tests }}'
        critical_count = '${{ steps.process_results.outputs.critical_count }}'
        high_count = '${{ steps.process_results.outputs.high_count }}'
        pass_rate = '${{ steps.process_results.outputs.pass_rate }}'
        cluster_name = os.environ.get('CLUSTER_NAME', 'unknown')
        
        # Slack ì›¹í›… URL
        slack_webhook = os.environ.get('SLACK_WEBHOOK_URL_SCAN')
        
        if not slack_webhook:
            print("âš ï¸ SLACK_WEBHOOK_URL_SCAN not configured")
            exit(0)
        
        # ì‹¬ê°ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë° ì´ëª¨ì§€ ê²°ì •
        if int(critical_count) > 0:
            color = "#FF0000"  # ë¹¨ê°„ìƒ‰
            status_emoji = "ğŸ”´"
            status_text = "CRITICAL"
        elif int(high_count) > 0:
            color = "#FF8C00"  # ì£¼í™©ìƒ‰
            status_emoji = "ğŸŸ "
            status_text = "HIGH"
        elif int(failed_tests) > 0:
            color = "#FFD700"  # ë…¸ë€ìƒ‰
            status_emoji = "ğŸŸ¡"
            status_text = "MEDIUM"
        else:
            color = "#00FF00"  # ì´ˆë¡ìƒ‰
            status_emoji = "ğŸŸ¢"
            status_text = "GOOD"
        
        # Slack ë©”ì‹œì§€ êµ¬ì„±
        slack_message = {
            "text": f"{status_emoji} Kube-bench EKS ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ",
            "attachments": [
                {
                    "color": color,
                    "fields": [
                        {
                            "title": "í´ëŸ¬ìŠ¤í„°",
                            "value": cluster_name,
                            "short": True
                        },
                        {
                            "title": "ê²€ì‚¬ ì‹œê°„",
                            "value": timestamp,
                            "short": True
                        },
                        {
                            "title": "ì „ì²´ í…ŒìŠ¤íŠ¸",
                            "value": total_tests,
                            "short": True
                        },
                        {
                            "title": "í†µê³¼ìœ¨",
                            "value": f"{pass_rate}%",
                            "short": True
                        },
                        {
                            "title": "ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸",
                            "value": failed_tests,
                            "short": True
                        },
                        {
                            "title": "ì‹¬ê°ë„ ìƒíƒœ",
                            "value": f"{status_emoji} {status_text}",
                            "short": True
                        }
                    ],
                    "footer": "Kube-bench EKS Security Scanner",
                    "ts": int(os.popen('date +%s').read().strip())
                }
            ]
        }
        
        # Critical ë˜ëŠ” High ì´ìŠˆê°€ ìˆëŠ” ê²½ìš° ì¶”ê°€ ì •ë³´
        if int(critical_count) > 0 or int(high_count) > 0:
            slack_message["attachments"][0]["fields"].extend([
                {
                    "title": "ğŸ”´ Critical ì´ìŠˆ",
                    "value": critical_count,
                    "short": True
                },
                {
                    "title": "ğŸŸ  High ì´ìŠˆ", 
                    "value": high_count,
                    "short": True
                }
            ])
            
            slack_message["attachments"].append({
                "color": "#FF0000",
                "text": "âš ï¸ *ì¦‰ì‹œ ì¡°ì¹˜ê°€ í•„ìš”í•œ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!*\nìƒì„¸ ë‚´ìš©ì€ GitHub Issuesë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
                "actions": [
                    {
                        "type": "button",
                        "text": "GitHub Issues ë³´ê¸°",
                        "url": f"https://github.com/{os.environ.get('GITHUB_REPOSITORY', '')}/issues?q=is%3Aissue+is%3Aopen+label%3Akube-bench"
                    }
                ]
            })
        
        # Slackìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        try:
            response = requests.post(slack_webhook, json=slack_message)
            if response.status_code == 200:
                print("âœ… Slack notification sent successfully")
            else:
                print(f"âŒ Failed to send Slack notification: {response.status_code}")
                print(response.text)
        except Exception as e:
            print(f"âŒ Error sending Slack notification: {e}")
        
        EOF
      env:
        SLACK_WEBHOOK_URL_SCAN: ${{ secrets.SLACK_WEBHOOK_URL_SCAN }}

    - name: ğŸ“ Upload Scan Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kube-bench-results-${{ steps.kube_bench_scan.outputs.timestamp }}
        path: |
          kube-bench-results-*.json
          kube-bench-analysis-*.json
          security-report-*.md
        retention-days: 30

    - name: ğŸ“¤ Upload Results to S3
      if: always()
      run: |
        TIMESTAMP=${{ steps.kube_bench_scan.outputs.timestamp }}
        RESULTS_FILE="kube-bench-results-${TIMESTAMP}.json"
        
        # íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ ! -f "$RESULTS_FILE" ]; then
          echo "âŒ Results file not found: $RESULTS_FILE"
          exit 1
        fi
        
        # ë‚ ì§œ ì •ë³´ ì¶”ì¶œ (KST ê¸°ì¤€)
        YEAR=$(TZ=Asia/Seoul date +%Y)
        MONTH=$(TZ=Asia/Seoul date +%m)
        DAY=$(TZ=Asia/Seoul date +%d)
        
        # S3 ê²½ë¡œ ì„¤ì •
        S3_BUCKET="${{ secrets.KUBE_BENCH_S3_BUCKET }}"
        if [ -z "$S3_BUCKET" ]; then
          echo "âŒ KUBE_BENCH_S3_BUCKET secret not configured"
          exit 1
        fi
        
        S3_DATE_PATH="s3://${S3_BUCKET}/kube-bench-results/year=${YEAR}/month=${MONTH}/day=${DAY}"
        S3_LATEST_PATH="s3://${S3_BUCKET}/kube-bench-results/latest"
        
        echo "ğŸ“¤ Uploading kube-bench results to S3..."
        echo "  - Source: ${RESULTS_FILE}"
        echo "  - S3 Bucket: ${S3_BUCKET}"
        echo "  - Date Path: year=${YEAR}/month=${MONTH}/day=${DAY}"
        echo "  - Cluster: ${{ env.CLUSTER_NAME }}"
        
        # ë©”íƒ€ë°ì´í„° ì¶”ê°€ë¥¼ ìœ„í•œ ì„ì‹œ íŒŒì¼ ìƒì„±
        python3 << 'EOF'
        import json
        import os
        from datetime import datetime
        
        timestamp = os.environ['TIMESTAMP']
        results_file = f"kube-bench-results-{timestamp}.json"
        
        try:
            # ì›ë³¸ ê²°ê³¼ íŒŒì¼ ì½ê¸°
            with open(results_file, 'r') as f:
                content = f.read()
            
            # JSON íŒŒì‹± ì‹œë„
            try:
                results_data = json.loads(content)
            except json.JSONDecodeError:
                # JSONì´ ì•„ë‹Œ ê²½ìš° í…ìŠ¤íŠ¸ë¡œ ë˜í•‘
                results_data = {"raw_output": content}
            
            # ë©”íƒ€ë°ì´í„° ì¶”ê°€
            enhanced_results = {
                "metadata": {
                    "timestamp": timestamp,
                    "scan_date_utc": datetime.utcnow().isoformat() + "Z",
                    "scan_date_kst": datetime.now().strftime("%Y-%m-%d %H:%M:%S KST"),
                    "cluster_name": os.environ.get('CLUSTER_NAME', 'unknown'),
                    "workflow_run_id": os.environ.get('GITHUB_RUN_ID', ''),
                    "workflow_run_number": os.environ.get('GITHUB_RUN_NUMBER', ''),
                    "commit_sha": os.environ.get('GITHUB_SHA', ''),
                    "repository": os.environ.get('GITHUB_REPOSITORY', ''),
                    "benchmark_version": "eks-1.0.1"
                },
                "results": results_data
            }
            
            # S3 ì—…ë¡œë“œìš© íŒŒì¼ ìƒì„±
            s3_filename = f"kube-bench-{timestamp}.json"
            with open(s3_filename, 'w') as f:
                json.dump(enhanced_results, f, indent=2, ensure_ascii=False)
            
            print(f"âœ… Enhanced results file created: {s3_filename}")
            
        except Exception as e:
            print(f"âŒ Error processing results: {e}")
            # ì‹¤íŒ¨ ì‹œ ì›ë³¸ íŒŒì¼ ì‚¬ìš©
            import shutil
            shutil.copy(results_file, f"kube-bench-{timestamp}.json")
            print(f"âš ï¸ Using original file as fallback")
        
        EOF
        
        # S3ì— ì—…ë¡œë“œ
        S3_FILENAME="kube-bench-${TIMESTAMP}.json"
        
        # ë‚ ì§œë³„ ê²½ë¡œì— ì—…ë¡œë“œ
        aws s3 cp "${S3_FILENAME}" \
          "${S3_DATE_PATH}/${S3_FILENAME}" \
          --content-type "application/json" \
          --metadata "cluster=${CLUSTER_NAME},scan-date=${YEAR}-${MONTH}-${DAY},timestamp=${TIMESTAMP}"
        
        if [ $? -eq 0 ]; then
          echo "âœ… Results uploaded to date path: ${S3_DATE_PATH}/${S3_FILENAME}"
        else
          echo "âŒ Failed to upload to date path"
          exit 1
        fi
        
        # ìµœì‹  ê²°ê³¼ë¡œë„ ì—…ë¡œë“œ (ë¹ ë¥¸ ì ‘ê·¼ìš©)
        aws s3 cp "${S3_FILENAME}" \
          "${S3_LATEST_PATH}/kube-bench-latest.json" \
          --content-type "application/json" \
          --metadata "cluster=${CLUSTER_NAME},scan-date=${YEAR}-${MONTH}-${DAY},timestamp=${TIMESTAMP}"
        
        if [ $? -eq 0 ]; then
          echo "âœ… Latest results updated: ${S3_LATEST_PATH}/kube-bench-latest.json"
        else
          echo "âš ï¸ Failed to update latest results (non-critical)"
        fi
        
        echo ""
        echo "ğŸ“Š S3 Upload Summary:"
        echo "  - Bucket: ${S3_BUCKET}"
        echo "  - Date Path: year=${YEAR}/month=${MONTH}/day=${DAY}"
        echo "  - Filename: ${S3_FILENAME}"
        echo "  - File Size: $(ls -lh ${S3_FILENAME} | awk '{print $5}')"
        echo ""
        echo "ğŸ” S3 Access Examples:"
        echo "  - Today's scans: aws s3 ls ${S3_DATE_PATH}/"
        echo "  - Latest scan: aws s3 cp ${S3_LATEST_PATH}/kube-bench-latest.json ."
        echo "  - Specific file: aws s3 cp ${S3_DATE_PATH}/${S3_FILENAME} ."
      
      env:
        CLUSTER_NAME: ${{ env.CLUSTER_NAME }}
        TIMESTAMP: ${{ steps.kube_bench_scan.outputs.timestamp }}

    - name: ğŸ“Š Update Security Dashboard
      if: always()
      run: |
        # ë³´ì•ˆ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)
        echo "ğŸ“Š Security scan completed at $(date)"
        echo "Results uploaded to GitHub artifacts and S3 for historical tracking"
        
        # S3 ê²½ë¡œ ì •ë³´ ì¶œë ¥
        YEAR=$(TZ=Asia/Seoul date +%Y)
        MONTH=$(TZ=Asia/Seoul date +%m)
        DAY=$(TZ=Asia/Seoul date +%d)
        S3_BUCKET="${{ secrets.KUBE_BENCH_S3_BUCKET }}"
        
        if [ -n "$S3_BUCKET" ]; then
          echo ""
          echo "ğŸ”— S3 Results Location:"
          echo "  - Latest: s3://${S3_BUCKET}/kube-bench-results/latest/kube-bench-latest.json"
          echo "  - Today: s3://${S3_BUCKET}/kube-bench-results/year=${YEAR}/month=${MONTH}/day=${DAY}/"
          echo ""
          echo "ğŸ“… Date-based Search Examples:"
          echo "  - List today: aws s3 ls s3://${S3_BUCKET}/kube-bench-results/year=${YEAR}/month=${MONTH}/day=${DAY}/"
          echo "  - List this month: aws s3 ls s3://${S3_BUCKET}/kube-bench-results/year=${YEAR}/month=${MONTH}/ --recursive"
          echo "  - List this year: aws s3 ls s3://${S3_BUCKET}/kube-bench-results/year=${YEAR}/ --recursive"
        fi
        
        # í–¥í›„ í™•ì¥: ë©”íŠ¸ë¦­ì„ ì™¸ë¶€ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œìœ¼ë¡œ ì „ì†¡
        # ì˜ˆ: Prometheus, CloudWatch, Datadog ë“±