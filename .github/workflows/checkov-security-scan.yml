name: ğŸ›¡ï¸ Checkov Security Scan

# íŠ¸ë¦¬ê±° ì¡°ê±´: k8s-OSS ë””ë ‰í„°ë¦¬ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'k8s-OSS/**'                    # k8s-OSS ë””ë ‰í„°ë¦¬ ë³€ê²½ ì‹œë§Œ
      - '.github/workflows/checkov-security-scan.yml'  # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ ì‹œ
  pull_request:
    branches: [ main ]
    paths:
      - 'k8s-OSS/**'
  workflow_dispatch:                    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

# ë™ì‹œ ì‹¤í–‰ ì œì–´ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checkov-scan:
    name: Checkov Security Analysis
    runs-on: ubuntu-latest
    
    # ê¶Œí•œ ì„¤ì • (SARIF ì—…ë¡œë“œë¥¼ ìœ„í•´ í•„ìš”)
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      actions: read
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0                  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë” ì •í™•í•œ ë¶„ì„)

    # 2. Checkov ê³µì‹ ì•¡ì…˜ìœ¼ë¡œ ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
    - name: ğŸ” Run Checkov Security Scan
      id: checkov
      uses: bridgecrewio/checkov-action@master
      with:
        # ìŠ¤ìº” ëŒ€ìƒ ì„¤ì •
        directory: k8s-OSS               # k8s-OSS ë””ë ‰í„°ë¦¬ë§Œ ìŠ¤ìº”
        framework: kubernetes,helm,dockerfile,yaml  # ì§€ì› í”„ë ˆì„ì›Œí¬
        
        # ì¶œë ¥ ì„¤ì •
        output_format: sarif,json,cli    # ë‹¤ì¤‘ ì¶œë ¥ í˜•ì‹
        output_file_path: |
          checkov-results.sarif
          checkov-results.json
          checkov-results.txt
        
        # ì‹¤í–‰ ì˜µì…˜
        soft_fail: true                  # PRì—ì„œëŠ” ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
        quiet: false                     # ìƒì„¸ ë¡œê·¸ ì¶œë ¥
        download_external_modules: true  # ì™¸ë¶€ ëª¨ë“ˆ ë‹¤ìš´ë¡œë“œ
        log_level: INFO                  # ë¡œê·¸ ë ˆë²¨
        
        # í•„í„°ë§ ì˜µì…˜
        skip_check: |                    # ì œì™¸í•  ê²€ì‚¬ (í•„ìš”ì‹œ ì¶”ê°€)
          CKV_K8S_43
          CKV_K8S_35
        
        # ì‹¬ê°ë„ í•„í„° (ì„ íƒì‚¬í•­)
        # check_severity: HIGH,CRITICAL
        
        # ì¶”ê°€ ì„¤ì •
        config_file: k8s-OSS/.checkov.yml  # ì„¤ì • íŒŒì¼ (ìˆëŠ” ê²½ìš°)

    # 3. GitHub Security Tabì— SARIF ì—…ë¡œë“œ
    - name: ğŸ“Š Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: checkov-results.sarif
        category: checkov-k8s-oss

    # 4. ê²°ê³¼ íŒŒì¼ë“¤ì„ Artifactsë¡œ ì €ì¥
    - name: ğŸ“ Upload Checkov Results as Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: checkov-security-results-${{ github.run_number }}
        path: |
          checkov-results.sarif
          checkov-results.json
          checkov-results.txt
        retention-days: 90

    # 5. ê²°ê³¼ ìš”ì•½ ìƒì„± ë° ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
    - name: ğŸ“Š Parse Checkov Results
      id: parse_results
      if: always()
      run: |
        if [ -f "checkov-results.json" ]; then
          # ê¸°ë³¸ ìš”ì•½ ì •ë³´
          PASSED=$(jq -r '.summary.passed // 0' checkov-results.json)
          FAILED=$(jq -r '.summary.failed // 0' checkov-results.json)
          SKIPPED=$(jq -r '.summary.skipped // 0' checkov-results.json)
          
          echo "passed_checks=$PASSED" >> $GITHUB_OUTPUT
          echo "failed_checks=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped_checks=$SKIPPED" >> $GITHUB_OUTPUT
          
          # ì‹¬ê°ë„ë³„ ë¶„ë¥˜
          CRITICAL=$(jq '[.results.failed_checks[]? | select(.severity == "CRITICAL")] | length' checkov-results.json)
          HIGH=$(jq '[.results.failed_checks[]? | select(.severity == "HIGH")] | length' checkov-results.json)
          MEDIUM=$(jq '[.results.failed_checks[]? | select(.severity == "MEDIUM")] | length' checkov-results.json)
          LOW=$(jq '[.results.failed_checks[]? | select(.severity == "LOW")] | length' checkov-results.json)
          
          echo "critical_issues=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high_issues=$HIGH" >> $GITHUB_OUTPUT
          echo "medium_issues=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low_issues=$LOW" >> $GITHUB_OUTPUT
          
          # ì½˜ì†” ì¶œë ¥
          echo "ğŸ“Š Checkov Scan Summary:"
          echo "  âœ… Passed: $PASSED"
          echo "  âŒ Failed: $FAILED"
          echo "  â­ï¸ Skipped: $SKIPPED"
          echo ""
          echo "ğŸ¯ Issues by Severity:"
          echo "  ğŸš¨ Critical: $CRITICAL"
          echo "  âš ï¸ High: $HIGH"
          echo "  ğŸ“ Medium: $MEDIUM"
          echo "  â„¹ï¸ Low: $LOW"
          
          # ì „ì²´ ì ìˆ˜ ê³„ì‚° (ì„ íƒì‚¬í•­)
          TOTAL_CHECKS=$((PASSED + FAILED))
          if [ $TOTAL_CHECKS -gt 0 ]; then
            PASS_RATE=$((PASSED * 100 / TOTAL_CHECKS))
            echo "ğŸ“ˆ Pass Rate: $PASS_RATE%"
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
          fi
        else
          echo "âš ï¸ Checkov results file not found"
          echo "failed_checks=0" >> $GITHUB_OUTPUT
          echo "critical_issues=0" >> $GITHUB_OUTPUT
        fi

    # 6. Pull Requestì— ê²°ê³¼ ì½”ë©˜íŠ¸ ì¶”ê°€
    - name: ğŸ’¬ Comment PR with Security Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            // ê²°ê³¼ íŒŒì¼ ì½ê¸°
            const results = JSON.parse(fs.readFileSync('checkov-results.json', 'utf8'));
            const summary = results.summary || {};
            
            const passed = summary.passed || 0;
            const failed = summary.failed || 0;
            const skipped = summary.skipped || 0;
            
            // ì‹¬ê°ë„ë³„ ë¶„ë¥˜
            const failedChecks = results.results?.failed_checks || [];
            const critical = failedChecks.filter(check => check.severity === 'CRITICAL').length;
            const high = failedChecks.filter(check => check.severity === 'HIGH').length;
            const medium = failedChecks.filter(check => check.severity === 'MEDIUM').length;
            const low = failedChecks.filter(check => check.severity === 'LOW').length;
            
            // ìƒíƒœ ê²°ì •
            let statusEmoji = 'âœ…';
            let statusText = 'All Clear!';
            let statusColor = '28a745'; // ë…¹ìƒ‰
            
            if (critical > 0) {
              statusEmoji = 'ğŸš¨';
              statusText = 'Critical Issues Found!';
              statusColor = 'dc3545'; // ë¹¨ê°„ìƒ‰
            } else if (high > 0) {
              statusEmoji = 'âš ï¸';
              statusText = 'High Priority Issues Found!';
              statusColor = 'fd7e14'; // ì£¼í™©ìƒ‰
            } else if (failed > 0) {
              statusEmoji = 'ğŸ“';
              statusText = 'Issues Found';
              statusColor = 'ffc107'; // ë…¸ë€ìƒ‰
            }
            
            // í†µê³¼ìœ¨ ê³„ì‚°
            const totalChecks = passed + failed;
            const passRate = totalChecks > 0 ? Math.round((passed / totalChecks) * 100) : 0;
            
            // PR ì½”ë©˜íŠ¸ ìƒì„±
            const comment = `## ${statusEmoji} Checkov Security Scan Results
            
            ![Status](https://img.shields.io/badge/Status-${encodeURIComponent(statusText)}-${statusColor})
            ![Pass Rate](https://img.shields.io/badge/Pass%20Rate-${passRate}%25-${passRate >= 80 ? '28a745' : passRate >= 60 ? 'ffc107' : 'dc3545'})
            
            ### ğŸ“Š Summary
            | Category | Count | Percentage |
            |----------|-------|------------|
            | âœ… Passed | ${passed} | ${totalChecks > 0 ? Math.round((passed/totalChecks)*100) : 0}% |
            | âŒ Failed | ${failed} | ${totalChecks > 0 ? Math.round((failed/totalChecks)*100) : 0}% |
            | â­ï¸ Skipped | ${skipped} | - |
            | **Total** | **${totalChecks}** | **100%** |
            
            ### ğŸ¯ Issues by Severity
            | Severity | Count | Priority |
            |----------|-------|----------|
            | ğŸš¨ Critical | ${critical} | Must Fix |
            | âš ï¸ High | ${high} | Should Fix |
            | ğŸ“ Medium | ${medium} | Consider Fix |
            | â„¹ï¸ Low | ${low} | Optional |
            
            ${failed > 0 ? `
            ### ğŸ” Top Failed Checks
            ${failedChecks.slice(0, 3).map((check, index) => 
              `#### ${index + 1}. ${check.severity} - ${check.check_id}
            **${check.check_name}**
            - ğŸ“ File: \`${check.file_path}\`
            - ğŸ“ Line: ${check.file_line_range ? check.file_line_range.join('-') : 'N/A'}
            - ğŸ”— [More Info](${check.guideline || '#'})
            `
            ).join('\n')}
            
            ${failedChecks.length > 3 ? `<details><summary>ğŸ“‹ View ${failedChecks.length - 3} more issues...</summary>\n\n${failedChecks.slice(3).map((check, index) => `${index + 4}. **${check.check_id}**: ${check.check_name} (${check.file_path})`).join('\n')}\n\n</details>` : ''}
            ` : '### ğŸ‰ No Security Issues Found!\nGreat job maintaining secure infrastructure code! ğŸ‘'}
            
            ### ğŸ“‹ Next Steps
            ${critical > 0 ? '- ğŸš¨ **Fix Critical issues immediately** - These pose serious security risks' : ''}
            ${high > 0 ? '- âš ï¸ **Address High priority issues** - These should be fixed before merging' : ''}
            ${medium > 0 ? '- ğŸ“ **Review Medium priority issues** - Consider fixing these for better security' : ''}
            - ğŸ“Š [View detailed results in Security tab](${context.payload.repository.html_url}/security/code-scanning)
            - ğŸ“ [Download full report from Artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ---
            <sub>ğŸ¤– Automated security scan by [Checkov](https://www.checkov.io/) | Run #${context.runNumber} | Scanned ${totalChecks} checks</sub>`;
            
            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Checkov Security Scan Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… Updated existing PR comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… Created new PR comment');
            }
            
          } catch (error) {
            console.error('âŒ Error processing Checkov results:', error);
            
            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ì½”ë©˜íŠ¸
            const errorComment = `## âš ï¸ Checkov Security Scan
            
            âŒ **Error occurred while processing scan results**
            
            \`\`\`
            ${error.message}
            \`\`\`
            
            Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
            
            ---
            <sub>ğŸ¤– Automated security scan by Checkov | Run #${context.runNumber}</sub>`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: errorComment
            });
          }

    # 7. ì‹¬ê°í•œ ë³´ì•ˆ ë¬¸ì œ ë°œê²¬ ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬ (ë©”ì¸ ë¸Œëœì¹˜ì—ì„œë§Œ)
    - name: ğŸš¨ Fail on Critical Security Issues
      if: |
        github.ref == 'refs/heads/main' && 
        steps.parse_results.outputs.critical_issues > 0
      run: |
        echo "ğŸš¨ Critical security issues found: ${{ steps.parse_results.outputs.critical_issues }}"
        echo "âŒ Workflow will fail due to critical security vulnerabilities in main branch"
        echo "ğŸ” Please review the Security tab and fix critical issues immediately"
        exit 1

    # 8. ìŠ¤ìº” ì™„ë£Œ ìš”ì•½
    - name: âœ… Security Scan Summary
      if: always()
      run: |
        echo "ğŸ‰ Checkov security scan completed!"
        echo ""
        echo "ğŸ“Š Final Results:"
        echo "  âœ… Passed: ${{ steps.parse_results.outputs.passed_checks || 0 }}"
        echo "  âŒ Failed: ${{ steps.parse_results.outputs.failed_checks || 0 }}"
        echo "  â­ï¸ Skipped: ${{ steps.parse_results.outputs.skipped_checks || 0 }}"
        echo ""
        echo "ğŸ¯ Security Issues:"
        echo "  ğŸš¨ Critical: ${{ steps.parse_results.outputs.critical_issues || 0 }}"
        echo "  âš ï¸ High: ${{ steps.parse_results.outputs.high_issues || 0 }}"
        echo "  ğŸ“ Medium: ${{ steps.parse_results.outputs.medium_issues || 0 }}"
        echo "  â„¹ï¸ Low: ${{ steps.parse_results.outputs.low_issues || 0 }}"
        echo ""
        
        if [ "${{ steps.parse_results.outputs.failed_checks || 0 }}" -gt 0 ]; then
          echo "ğŸ”§ Action Required:"
          echo "  - Review failed security checks"
          echo "  - Fix critical and high priority issues"
          echo "  - Check Security tab for detailed guidance"
        else
          echo "ğŸ‰ Excellent! No security issues found!"
          echo "  - Your infrastructure code follows security best practices"
          echo "  - Keep up the great work! ğŸ‘"
        fi
        
        echo ""
        echo "ğŸ“‹ Resources:"
        echo "  - Security Tab: ${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
        echo "  - Artifacts: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "  - Checkov Docs: https://www.checkov.io/"