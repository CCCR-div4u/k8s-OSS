name: Smart Checkov Security Scan

on:
  pull_request:
    # ë„“ì€ ë²”ìœ„ë¡œ ì„¤ì •í•˜ì—¬ ë³€ê²½ ê°ì§€ ë¡œì§ì—ì„œ ì²˜ë¦¬
    paths:
      - "argo-cd/**"
      - "harbor/**"
      - "keycloak/**"
      - "sonarqube/**"
      - "thanos/**"
      - "monitoring_o11y/**"
      - ".github/workflows/checkov-security-scan.yml"
  push:
    branches: [ main ]
    paths:
      - "argo-cd/**"
      - "harbor/**"
      - "keycloak/**"
      - "sonarqube/**"
      - "thanos/**"
      - "monitoring_o11y/**"
      - ".github/workflows/checkov-security-scan.yml"

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

concurrency:
  group: checkov-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ë³€ê²½ ê°ì§€ ë° ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
  detect:
    runs-on: ubuntu-latest
    outputs:
      workflows: ${{ steps.filter.outputs.workflows }}
      argo_cd: ${{ steps.filter.outputs.argo_cd }}
      harbor: ${{ steps.filter.outputs.harbor }}
      keycloak: ${{ steps.filter.outputs.keycloak }}
      sonarqube: ${{ steps.filter.outputs.sonarqube }}
      thanos: ${{ steps.filter.outputs.thanos }}
      monitoring: ${{ steps.filter.outputs.monitoring }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      scan_mode: ${{ steps.set-matrix.outputs.scan_mode }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            workflows:
              - '.github/workflows/checkov-security-scan.yml'
            argo_cd:
              - 'argo-cd/**'
            harbor:
              - 'harbor/**'
            keycloak:
              - 'keycloak/**'
            sonarqube:
              - 'sonarqube/**'
            thanos:
              - 'thanos/**'
            monitoring:
              - 'monitoring_o11y/**'

      - name: Set matrix and scan mode
        id: set-matrix
        run: |
          # ì „ì²´ ì»´í¬ë„ŒíŠ¸ ë§¤íŠ¸ë¦­ìŠ¤ ì •ì˜
          FULL_MATRIX='{
            "include": [
              {
                "name": "argo-cd",
                "chart_ref": "argo/argo-cd",
                "values": "argo-cd/my-values.yaml",
                "scan_type": "helm"
              },
              {
                "name": "harbor", 
                "chart_ref": "goharbor/harbor",
                "values": "harbor/override-values.yaml",
                "scan_type": "helm"
              },
              {
                "name": "keycloak",
                "chart_ref": "bitnami/keycloak", 
                "values": "keycloak/installation/helm-values.yaml",
                "scan_type": "helm"
              },
              {
                "name": "sonarqube",
                "chart_ref": "sonarqube/sonarqube",
                "values": "sonarqube/override-values.yaml",
                "scan_type": "helm"
              },
              {
                "name": "thanos",
                "chart_ref": "bitnami/thanos",
                "values": "thanos/values/values.yaml",
                "scan_type": "helm"
              },
              {
                "name": "monitoring_o11y",
                "chart_ref": "",
                "values": "",
                "scan_type": "kubernetes"
              }
            ]
          }'
          
          # ì›Œí¬í”Œë¡œ íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš° ì „ì²´ ìŠ¤ìº”
          if [ "${{ steps.filter.outputs.workflows }}" = "true" ]; then
            echo "ğŸ”„ ì›Œí¬í”Œë¡œ íŒŒì¼ ë³€ê²½ ê°ì§€ - ì „ì²´ ìŠ¤ìº” ëª¨ë“œ"
            echo "matrix=$FULL_MATRIX" >> $GITHUB_OUTPUT
            echo "scan_mode=full_scan" >> $GITHUB_OUTPUT
            echo "::notice::ì›Œí¬í”Œë¡œ íŒŒì¼ì´ ë³€ê²½ë˜ì–´ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ë¥¼ ìŠ¤ìº”í•©ë‹ˆë‹¤."
            exit 0
          fi
          
          # ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ ìŠ¤ìº”
          CHANGED_COMPONENTS=""
          
          if [ "${{ steps.filter.outputs.argo_cd }}" = "true" ]; then
            CHANGED_COMPONENTS="$CHANGED_COMPONENTS argo-cd"
          fi
          if [ "${{ steps.filter.outputs.harbor }}" = "true" ]; then
            CHANGED_COMPONENTS="$CHANGED_COMPONENTS harbor"
          fi
          if [ "${{ steps.filter.outputs.keycloak }}" = "true" ]; then
            CHANGED_COMPONENTS="$CHANGED_COMPONENTS keycloak"
          fi
          if [ "${{ steps.filter.outputs.sonarqube }}" = "true" ]; then
            CHANGED_COMPONENTS="$CHANGED_COMPONENTS sonarqube"
          fi
          if [ "${{ steps.filter.outputs.thanos }}" = "true" ]; then
            CHANGED_COMPONENTS="$CHANGED_COMPONENTS thanos"
          fi
          if [ "${{ steps.filter.outputs.monitoring }}" = "true" ]; then
            CHANGED_COMPONENTS="$CHANGED_COMPONENTS monitoring_o11y"
          fi
          
          # ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë§¤íŠ¸ë¦­ìŠ¤
          if [ -z "$CHANGED_COMPONENTS" ]; then
            echo "â­ï¸ ìŠ¤ìº” ëŒ€ìƒ ë””ë ‰í„°ë¦¬ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "scan_mode=no_changes" >> $GITHUB_OUTPUT
            echo "::notice::ë³€ê²½ëœ ìŠ¤ìº” ëŒ€ìƒì´ ì—†ì–´ ë³´ì•ˆ ê²€ì‚¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi
          
          # ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ í¬í•¨í•˜ëŠ” ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
          echo "ğŸ¯ ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸: $CHANGED_COMPONENTS"
          
          MATRIX_ITEMS=""
          for component in $CHANGED_COMPONENTS; do
            case $component in
              "argo-cd")
                ITEM='{"name": "argo-cd", "chart_ref": "argo/argo-cd", "values": "argo-cd/my-values.yaml", "scan_type": "helm"}'
                ;;
              "harbor")
                ITEM='{"name": "harbor", "chart_ref": "goharbor/harbor", "values": "harbor/override-values.yaml", "scan_type": "helm"}'
                ;;
              "keycloak")
                ITEM='{"name": "keycloak", "chart_ref": "bitnami/keycloak", "values": "keycloak/installation/helm-values.yaml", "scan_type": "helm"}'
                ;;
              "sonarqube")
                ITEM='{"name": "sonarqube", "chart_ref": "sonarqube/sonarqube", "values": "sonarqube/override-values.yaml", "scan_type": "helm"}'
                ;;
              "thanos")
                ITEM='{"name": "thanos", "chart_ref": "bitnami/thanos", "values": "thanos/values/values.yaml", "scan_type": "helm"}'
                ;;
              "monitoring_o11y")
                ITEM='{"name": "monitoring_o11y", "chart_ref": "", "values": "", "scan_type": "kubernetes"}'
                ;;
            esac
            
            if [ -n "$MATRIX_ITEMS" ]; then
              MATRIX_ITEMS="$MATRIX_ITEMS,$ITEM"
            else
              MATRIX_ITEMS="$ITEM"
            fi
          done
          
          CHANGED_MATRIX="{\"include\":[$MATRIX_ITEMS]}"
          echo "matrix=$CHANGED_MATRIX" >> $GITHUB_OUTPUT
          echo "scan_mode=changed_scan" >> $GITHUB_OUTPUT
          echo "::notice::ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ ìŠ¤ìº”í•©ë‹ˆë‹¤: $CHANGED_COMPONENTS"

  # ë³€ê²½ì‚¬í•­ì´ ì—†ì„ ë•Œ ë¹ ë¥¸ ì„±ê³µ ì¢…ë£Œ
  no-changes:
    needs: detect
    if: needs.detect.outputs.scan_mode == 'no_changes'
    runs-on: ubuntu-latest
    steps:
      - name: No changes detected
        run: |
          echo "âœ… ìŠ¤ìº” ëŒ€ìƒ ë””ë ‰í„°ë¦¬ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "ğŸ“ ëª¨ë‹ˆí„°ë§ëœ ë””ë ‰í„°ë¦¬: argo-cd, harbor, keycloak, sonarqube, thanos"
          echo "ğŸ”§ ì›Œí¬í”Œë¡œ íŒŒì¼: .github/workflows/checkov-security-scan.yml"
          echo ""
          echo "ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ë©´ ìë™ìœ¼ë¡œ ë³´ì•ˆ ìŠ¤ìº”ì´ ì‹¤í–‰ë©ë‹ˆë‹¤."
          echo "::notice::ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë³´ì•ˆ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤."
  # ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
  scan:
    needs: detect
    if: needs.detect.outputs.scan_mode != 'no_changes'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Display scan info
        run: |
          echo "ğŸ” ìŠ¤ìº” ëª¨ë“œ: ${{ needs.detect.outputs.scan_mode }}"
          echo "ğŸ“¦ ì»´í¬ë„ŒíŠ¸: ${{ matrix.name }}"
          echo "ğŸ”§ ìŠ¤ìº” íƒ€ì…: ${{ matrix.scan_type }}"
          
          if [ "${{ matrix.scan_type }}" = "helm" ]; then
            echo "ğŸ“Š ì°¨íŠ¸: ${{ matrix.chart_ref }}"
            echo "âš™ï¸ Values: ${{ matrix.values }}"
          else
            echo "ğŸ“‹ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì§ì ‘ ìŠ¤ìº”"
          fi
          
          if [ "${{ needs.detect.outputs.scan_mode }}" = "full_scan" ]; then
            echo "::notice::ì „ì²´ ìŠ¤ìº” ëª¨ë“œ - ì›Œí¬í”Œë¡œ íŒŒì¼ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ì „ì²´ ê²€ì‚¬"
          else
            echo "::notice::ë³€ê²½ ìŠ¤ìº” ëª¨ë“œ - ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ ê²€ì‚¬"
          fi

      # Helm v3 ì„¤ì¹˜
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      # Helm ì €ì¥ì†Œ ì¶”ê°€
      - name: Add Helm repos
        run: |
          echo "ğŸ“¥ Helm ì €ì¥ì†Œ ì¶”ê°€ ì¤‘..."
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add goharbor https://helm.goharbor.io
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo add sonarqube https://SonarSource.github.io/helm-chart-sonarqube
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update
          echo "âœ… Helm ì €ì¥ì†Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      # ë””ë ‰í„°ë¦¬ ìƒì„±
      - name: Prepare directories
        run: |
          mkdir -p rendered results
          echo "ğŸ“ ë””ë ‰í„°ë¦¬ ìƒì„± ì™„ë£Œ: rendered, results"

      # Helm í…œí”Œë¦¿ ë Œë”ë§ (Helm ì°¨íŠ¸ì¸ ê²½ìš°)
      - name: Helm template (${{ matrix.name }})
        if: matrix.scan_type == 'helm'
        env:
          NAME: ${{ matrix.name }}
          CHART: ${{ matrix.chart_ref }}
          VALUES: ${{ matrix.values }}
        run: |
          set -euo pipefail
          echo "ğŸ¨ Helm í…œí”Œë¦¿ ë Œë”ë§: $NAME"
          
          VALUES_FLAGS=""
          for v in $VALUES; do
            if [ -f "$v" ]; then
              echo "âœ… Values íŒŒì¼ ì‚¬ìš©: $v"
              VALUES_FLAGS="$VALUES_FLAGS -f $v"
            else
              echo "âš ï¸ Values íŒŒì¼ ì—†ìŒ (ê±´ë„ˆëœ€): $v"
            fi
          done
          
          echo "ğŸ”§ ì‹¤í–‰ ëª…ë ¹ì–´: helm template $NAME $CHART $VALUES_FLAGS --namespace $NAME --create-namespace"
          
          helm template "$NAME" "$CHART" $VALUES_FLAGS \
            --namespace "$NAME" \
            --create-namespace \
            > "rendered/${NAME}.yaml"
          
          # ë Œë”ë§ ê²°ê³¼ í™•ì¸
          if [ ! -s "rendered/${NAME}.yaml" ]; then
            echo "âŒ ë Œë”ë§ ì‹¤íŒ¨: ë¹ˆ íŒŒì¼ ìƒì„±ë¨"
            exit 1
          fi
          
          LINES=$(wc -l < "rendered/${NAME}.yaml")
          SIZE=$(wc -c < "rendered/${NAME}.yaml")
          echo "âœ… ë Œë”ë§ ì™„ë£Œ: ${LINES}ì¤„, ${SIZE}ë°”ì´íŠ¸"

      # Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³µì‚¬ (ìˆœìˆ˜ K8s íŒŒì¼ì¸ ê²½ìš°)
      - name: Copy Kubernetes manifests (${{ matrix.name }})
        if: matrix.scan_type == 'kubernetes'
        env:
          NAME: ${{ matrix.name }}
        run: |
          set -euo pipefail
          echo "ğŸ“‹ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³µì‚¬: $NAME"
          
          # monitoring_o11y ë””ë ‰í„°ë¦¬ì˜ ëª¨ë“  YAML íŒŒì¼ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°
          find "$NAME" -name "*.yaml" -o -name "*.yml" | while read -r file; do
            echo "ğŸ“„ ì²˜ë¦¬ ì¤‘: $file"
            echo "---" >> "rendered/${NAME}.yaml"
            cat "$file" >> "rendered/${NAME}.yaml"
          done
          
          # ê²°ê³¼ í™•ì¸
          if [ ! -s "rendered/${NAME}.yaml" ]; then
            echo "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          LINES=$(wc -l < "rendered/${NAME}.yaml")
          SIZE=$(wc -c < "rendered/${NAME}.yaml")
          echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³µì‚¬ ì™„ë£Œ: ${LINES}ì¤„, ${SIZE}ë°”ì´íŠ¸"

      # Checkov ë³´ì•ˆ ê²€ì‚¬
      - name: Run Checkov security scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: rendered
          framework: kubernetes
          quiet: true
          output_format: json,sarif
          output_file_path: results/${{ matrix.name }}.json,results/${{ matrix.name }}.sarif
          soft_fail: true
          log_level: WARNING

      # ìŠ¤ìº” ê²°ê³¼ ê²€ì¦
      - name: Validate scan results
        if: always()
        run: |
          echo "ğŸ“Š ìŠ¤ìº” ê²°ê³¼ ê²€ì¦ ì¤‘..."
          ls -lah results/ || true
          
          JSON_FILE="results/${{ matrix.name }}.json"
          SARIF_FILE="results/${{ matrix.name }}.sarif"
          
          # JSON íŒŒì¼ ê²€ì¦
          if [ -f "$JSON_FILE" ] && [ -s "$JSON_FILE" ]; then
            JSON_SIZE=$(wc -c < "$JSON_FILE")
            echo "âœ… JSON ê²°ê³¼: ${JSON_SIZE}ë°”ì´íŠ¸"
            
            # JSON ìœ íš¨ì„± ê²€ì‚¬
            if python3 -m json.tool "$JSON_FILE" > /dev/null 2>&1; then
              echo "âœ… JSON í˜•ì‹ ìœ íš¨"
            else
              echo "âš ï¸ JSON í˜•ì‹ ì˜¤ë¥˜"
            fi
          else
            echo "âŒ JSON ê²°ê³¼ íŒŒì¼ ì—†ìŒ ë˜ëŠ” ë¹ˆ íŒŒì¼"
          fi
          
          # SARIF íŒŒì¼ ê²€ì¦
          if [ -f "$SARIF_FILE" ] && [ -s "$SARIF_FILE" ]; then
            SARIF_SIZE=$(wc -c < "$SARIF_FILE")
            echo "âœ… SARIF ê²°ê³¼: ${SARIF_SIZE}ë°”ì´íŠ¸"
            
            # SARIF ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 20ì¤„)
            echo "ğŸ“„ SARIF ë¯¸ë¦¬ë³´ê¸°:"
            head -n 20 "$SARIF_FILE" | sed -e 's/::/--/g' || true
          else
            echo "âŒ SARIF ê²°ê³¼ íŒŒì¼ ì—†ìŒ ë˜ëŠ” ë¹ˆ íŒŒì¼"
          fi
      # OpenAI APIë¥¼ í†µí•œ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ë¶„ì„
      - name: Analyze security scan results with OpenAI
        if: always()
        id: openai-analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          JSON_FILE="results/${{ matrix.name }}.json"
          
          if [ ! -f "$JSON_FILE" ] || [ ! -s "$JSON_FILE" ]; then
            echo "ğŸ“„ JSON ê²°ê³¼ íŒŒì¼ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
            echo "analysis_result=ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ìŠ¤ìº”ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            echo "issue_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ¤– OpenAIë¥¼ í†µí•œ ë³´ì•ˆ ë¶„ì„ ì‹œì‘..."
          
          # OpenAI API í˜¸ì¶œì„ ìœ„í•œ Python ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > analyze_security.py << 'EOF'
          import json
          import os
          import sys
          import requests
          
          def analyze_checkov_results(json_file):
              try:
                  with open(json_file, 'r') as f:
                      data = json.load(f)
                  
                  # Checkov ê²°ê³¼ì—ì„œ ì‹¤íŒ¨í•œ ê²€ì‚¬ë“¤ ì¶”ì¶œ
                  failed_checks = data.get('results', {}).get('failed_checks', [])
                  
                  if not failed_checks:
                      return "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼: ë°œê²¬ëœ ë³´ì•ˆ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
                  
                  # ì‹¬ê°ë„ë³„ ë¶„ë¥˜
                  critical_issues = []
                  high_issues = []
                  medium_issues = []
                  low_issues = []
                  
                  for check in failed_checks:
                      severity = check.get('severity')
                      if severity:
                          severity = severity.upper()
                      else:
                          severity = 'UNKNOWN'
                      issue_info = {
                          'check_id': check.get('check_id', 'N/A'),
                          'check_name': check.get('check_name', 'N/A'),
                          'file_path': check.get('file_path', 'N/A'),
                          'resource': check.get('resource', 'N/A'),
                          'description': check.get('description', 'N/A')
                      }
                      
                      if severity == 'CRITICAL':
                          critical_issues.append(issue_info)
                      elif severity == 'HIGH':
                          high_issues.append(issue_info)
                      elif severity == 'MEDIUM':
                          medium_issues.append(issue_info)
                      else:
                          low_issues.append(issue_info)
                  
                  # OpenAI API í˜¸ì¶œ
                  api_key = os.getenv('OPENAI_API_KEY')
                  if not api_key:
                      return generate_basic_report(critical_issues, high_issues, medium_issues, low_issues)
                  
                  prompt = f"""
          ë‹¤ìŒì€ Kubernetes ë³´ì•ˆ ê²€ì‚¬(Checkov) ê²°ê³¼ì…ë‹ˆë‹¤. ì—”ì§€ë‹ˆì–´ì—ê²Œ ì „ë‹¬í•  ë³´ê³ ì„œë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          
          Critical ì´ìŠˆ: {len(critical_issues)}ê°œ
          High ì´ìŠˆ: {len(high_issues)}ê°œ  
          Medium ì´ìŠˆ: {len(medium_issues)}ê°œ
          Low ì´ìŠˆ: {len(low_issues)}ê°œ
          
          ìƒì„¸ ì´ìŠˆë“¤:
          {json.dumps({'critical': critical_issues, 'high': high_issues, 'medium': medium_issues, 'low': low_issues}, indent=2, ensure_ascii=False)}
          
          ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:
          1. ìš”ì•½ (ì „ì²´ì ì¸ ë³´ì•ˆ ìƒíƒœ)
          2. ìš°ì„ ìˆœìœ„ë³„ ì´ìŠˆ ë¶„ì„
          3. ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
          4. ì¶”ê°€ ê²€í† ê°€ í•„ìš”í•œ ì‚¬í•­
          
          ë³´ê³ ì„œëŠ” ê°„ê²°í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          """
                  
                  try:
                      response = requests.post(
                          'https://api.openai.com/v1/chat/completions',
                          headers={
                              'Authorization': f'Bearer {api_key}',
                              'Content-Type': 'application/json'
                          },
                          json={
                              'model': 'gpt-4o-mini',
                              'messages': [
                                  {'role': 'system', 'content': 'ë‹¹ì‹ ì€ Kubernetes ë³´ì•ˆ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì—¬ ì—”ì§€ë‹ˆì–´ì—ê²Œ ëª…í™•í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë³´ê³ ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.'},
                                  {'role': 'user', 'content': prompt}
                              ],
                              'max_tokens': 2000,
                              'temperature': 0.3
                          },
                          timeout=30
                      )
                      
                      if response.status_code == 200:
                          result = response.json()
                          return result['choices'][0]['message']['content']
                      else:
                          print(f"OpenAI API ì˜¤ë¥˜: {response.status_code}")
                          return generate_basic_report(critical_issues, high_issues, medium_issues, low_issues)
                          
                  except Exception as e:
                      print(f"OpenAI API í˜¸ì¶œ ì‹¤íŒ¨: {e}")
                      return generate_basic_report(critical_issues, high_issues, medium_issues, low_issues)
                      
              except Exception as e:
                  return f"âŒ ë¶„ì„ ì‹¤íŒ¨: {str(e)}"
          
          def generate_basic_report(critical, high, medium, low):
              total_issues = len(critical) + len(high) + len(medium) + len(low)
              
              report = f"""## ğŸ”’ Kubernetes ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼
          
          ### ğŸ“Š ìš”ì•½
          - **ì´ ì´ìŠˆ**: {total_issues}ê°œ
          - **Critical**: {len(critical)}ê°œ ğŸ”´
          - **High**: {len(high)}ê°œ ğŸŸ   
          - **Medium**: {len(medium)}ê°œ ğŸŸ¡
          - **Low**: {len(low)}ê°œ âšª
          
          ### ğŸš¨ ìš°ì„  ì¡°ì¹˜ í•„ìš” (Critical + High)
          """
              
              priority_issues = critical + high
              if priority_issues:
                  for i, issue in enumerate(priority_issues[:5], 1):  # ìƒìœ„ 5ê°œë§Œ í‘œì‹œ
                      report += f"""
          **{i}. {issue['check_name']}**
          - íŒŒì¼: `{issue['file_path']}`
          - ë¦¬ì†ŒìŠ¤: `{issue['resource']}`
          - ì„¤ëª…: {issue['description']}
          """
              else:
                  report += "\nâœ… ìš°ì„  ì¡°ì¹˜ê°€ í•„ìš”í•œ Critical/High ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
              
              if len(priority_issues) > 5:
                  report += f"\n\n*ì¶”ê°€ë¡œ {len(priority_issues) - 5}ê°œì˜ ìš°ì„ ìˆœìœ„ ì´ìŠˆê°€ ë” ìˆìŠµë‹ˆë‹¤.*"
              
              report += f"""
          
          ### ğŸ“‹ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
          1. Critical/High ì´ìŠˆë¥¼ ìš°ì„ ì ìœ¼ë¡œ í•´ê²°í•˜ì„¸ìš”
          2. ë³´ì•ˆ ì •ì±… ë° ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ê²€í† í•˜ì„¸ìš”  
          3. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë³´ì•ˆì„ ê°•í™”í•˜ì„¸ìš”
          4. RBAC ì„¤ì •ì„ ì ê²€í•˜ì„¸ìš”
          
          ì „ì²´ ìƒì„¸ ê²°ê³¼ëŠ” GitHub Actions ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          """
              
              return report
          
          if __name__ == "__main__":
              if len(sys.argv) != 2:
                  print("Usage: python analyze_security.py <json_file>")
                  sys.exit(1)
              
              result = analyze_checkov_results(sys.argv[1])
              print(result)
          EOF
          
          # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python3 analyze_security.py "$JSON_FILE" > analysis_result.txt
          
          # GitHub Outputì— ê²°ê³¼ ì €ì¥ (ë©€í‹°ë¼ì¸ ì²˜ë¦¬)
          echo "analysis_result<<EOF" >> $GITHUB_OUTPUT
          cat analysis_result.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # ì´ìŠˆ ê°œìˆ˜ í™•ì¸
          ISSUE_COUNT=$(python3 -c "
          import json
          try:
              with open('$JSON_FILE', 'r') as f:
                  data = json.load(f)
              failed_checks = data.get('results', {}).get('failed_checks', [])
              print(len(failed_checks))
          except:
              print(0)
          ")
          
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š ë°œê²¬ëœ ë³´ì•ˆ ì´ìŠˆ: $ISSUE_COUNTê°œ"
      # GitHub Issue ìƒì„± (ë³´ì•ˆ ì´ìŠˆê°€ ìˆì„ ë•Œ)
      - name: Create security issue
        if: always() && steps.openai-analysis.outputs.issue_count != '0'
        uses: actions/github-script@v7
        env:
          ANALYSIS_RESULT: ${{ steps.openai-analysis.outputs.analysis_result }}
          SCAN_MODE: ${{ needs.detect.outputs.scan_mode }}
        with:
          script: |
            const analysis = process.env.ANALYSIS_RESULT;
            const component = '${{ matrix.name }}';
            const issueCount = '${{ steps.openai-analysis.outputs.issue_count }}';
            const scanMode = process.env.SCAN_MODE;
            
            console.log(`ğŸ” ì´ìŠˆ ìƒì„± ì‹œì‘: ${component} (${issueCount}ê°œ ì´ìŠˆ)`);
            
            // ë³´ì•ˆ ì´ìŠˆê°€ ìˆìœ¼ë©´ Issue ìƒì„±
            if (issueCount && issueCount !== '0') {
              // ì‹¬ê°ë„ë³„ ì´ìŠˆ ê°œìˆ˜ ë¶„ì„
              const fs = require('fs');
              let criticalCount = 0;
              let highCount = 0;
              let mediumCount = 0;
              let lowCount = 0;
              let unknownCount = 0;
              let priorityLabel = 'low';
              
              try {
                const jsonFile = `results/${component}.json`;
                if (fs.existsSync(jsonFile)) {
                  const data = JSON.parse(fs.readFileSync(jsonFile, 'utf8'));
                  const failedChecks = data.results?.failed_checks || [];
                  
                  failedChecks.forEach(check => {
                    const severity = check.severity?.toUpperCase() || 'UNKNOWN';
                    switch(severity) {
                      case 'CRITICAL': criticalCount++; break;
                      case 'HIGH': highCount++; break;
                      case 'MEDIUM': mediumCount++; break;
                      case 'LOW': lowCount++; break;
                      default: unknownCount++; break;
                    }
                  });
                  
                  // ìš°ì„ ìˆœìœ„ ë¼ë²¨ ê²°ì •
                  if (criticalCount > 0) priorityLabel = 'critical';
                  else if (highCount > 0) priorityLabel = 'high';
                  else if (mediumCount > 0) priorityLabel = 'medium';
                  else priorityLabel = 'low';
                }
              } catch (e) {
                console.log('JSON íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', e);
                unknownCount = parseInt(issueCount) || 0;
              }
              
              // ì‹¬ê°ë„ë³„ ì´ëª¨ì§€ì™€ ê°œìˆ˜ í‘œì‹œ
              const severityBadges = [];
              if (criticalCount > 0) severityBadges.push(`ğŸ”´ Critical: ${criticalCount}`);
              if (highCount > 0) severityBadges.push(`ğŸŸ  High: ${highCount}`);
              if (mediumCount > 0) severityBadges.push(`ğŸŸ¡ Medium: ${mediumCount}`);
              if (lowCount > 0) severityBadges.push(`âšª Low: ${lowCount}`);
              if (unknownCount > 0) severityBadges.push(`âš« Unknown: ${unknownCount}`);
              
              const severityDisplay = severityBadges.join(' | ');
              const totalIssues = criticalCount + highCount + mediumCount + lowCount + unknownCount;
              
              // ìŠ¤ìº” ëª¨ë“œ í‘œì‹œ
              const scanModeText = scanMode === 'full_scan' 
                ? 'ğŸ”„ ì „ì²´ ìŠ¤ìº” (ì›Œí¬í”Œë¡œ ë³€ê²½)'
                : 'ğŸ¯ ë³€ê²½ ìŠ¤ìº” (ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ)';
              
              // ì œëª© ìƒì„±
              const hasCriticalHigh = criticalCount > 0 || highCount > 0;
              const title = hasCriticalHigh 
                ? `ğŸš¨ ê¸´ê¸‰ ë³´ì•ˆ ì´ìŠˆ - ${component} (ì´ ${totalIssues}ê°œ)`
                : `ğŸ”’ ë³´ì•ˆ ê²€í†  í•„ìš” - ${component} (ì´ ${totalIssues}ê°œ)`;
              
              // ì´ìŠˆ ë³¸ë¬¸ ìƒì„±
              const body = `## ğŸ“Š ë³´ì•ˆ ì´ìŠˆ ìš”ì•½
            
            **ì»´í¬ë„ŒíŠ¸**: \`${component}\`  
            **ì´ ì´ìŠˆ ê°œìˆ˜**: ${totalIssues}ê°œ  
            **ìŠ¤ìº” ëª¨ë“œ**: ${scanModeText}
            
            ### ğŸ¯ ì‹¬ê°ë„ë³„ ë¶„í¬
            ${severityDisplay}
            
            ---
            
            ${analysis}
            
            ## ğŸ“‹ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸
            ${criticalCount > 0 ? '- [ ] ğŸ”´ **Critical ì´ìŠˆ ì¦‰ì‹œ í•´ê²°** (ë³´ì•ˆ ìœ„í—˜ ë†’ìŒ)' : ''}
            ${highCount > 0 ? '- [ ] ğŸŸ  **High ì´ìŠˆ ìš°ì„  í•´ê²°** (ë³´ì•ˆ ìœ„í—˜ ìˆìŒ)' : ''}
            ${mediumCount > 0 ? '- [ ] ğŸŸ¡ **Medium ì´ìŠˆ ê²€í† ** (ë³´ì•ˆ ê°œì„  í•„ìš”)' : ''}
            ${lowCount > 0 ? '- [ ] âšª **Low ì´ìŠˆ ê²€í† ** (ë³´ì•ˆ ê°•í™” ê¶Œì¥)' : ''}
            - [ ] ğŸ“ ìˆ˜ì •ì‚¬í•­ ì ìš© ë° í…ŒìŠ¤íŠ¸
            - [ ] ğŸ”„ ì¬ê²€ì‚¬ ìˆ˜í–‰
            - [ ] âœ… ì´ìŠˆ í•´ê²° í™•ì¸
            
            ## ğŸ”— ê´€ë ¨ ë§í¬
            - [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ë³´ì•ˆ ì •ì±… ê°€ì´ë“œ](https://github.com/${{ github.repository }}/blob/main/SECURITY.md)
            - [Checkov ë¬¸ì„œ](https://www.checkov.io/5.Policy%20Index/kubernetes.html)
            
            ---
            *ğŸ¤– ìë™ ìƒì„±ëœ ë³´ì•ˆ ì´ìŠˆì…ë‹ˆë‹¤. ëª¨ë“  ì´ìŠˆ í•´ê²° í›„ ì´ Issueë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.*
            *ğŸ“… ìƒì„± ì‹œê°„: ${new Date().toISOString()}*`;
              
              const labels = ['security', 'checkov', component, priorityLabel, 'automated'];
              
              try {
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: labels
                });
                
                console.log(`âœ… Issue ìƒì„± ì™„ë£Œ: ${title}`);
                console.log(`ğŸ“Š ì‹¬ê°ë„ ë¶„í¬: ${severityDisplay}`);
                console.log(`ğŸ”— Issue URL: ${issue.data.html_url}`);
              } catch (error) {
                console.error('âŒ Issue ìƒì„± ì‹¤íŒ¨:', error);
              }
            }

      # Slack ì•Œë¦¼ (ì›¹í›… URLì´ ì„¤ì •ëœ ê²½ìš°)
      - name: Send Slack notification
        if: always() && steps.openai-analysis.outputs.issue_count != '0' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ANALYSIS_RESULT: ${{ steps.openai-analysis.outputs.analysis_result }}
          COMPONENT: ${{ matrix.name }}
          ISSUE_COUNT: ${{ steps.openai-analysis.outputs.issue_count }}
          SCAN_MODE: ${{ needs.detect.outputs.scan_mode }}
        run: |
          echo "ğŸ“¢ Slack ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          
          # ìŠ¤ìº” ëª¨ë“œ í…ìŠ¤íŠ¸
          if [ "$SCAN_MODE" = "full_scan" ]; then
            SCAN_MODE_TEXT="ğŸ”„ ì „ì²´ ìŠ¤ìº” (ì›Œí¬í”Œë¡œ ë³€ê²½)"
          else
            SCAN_MODE_TEXT="ğŸ¯ ë³€ê²½ ìŠ¤ìº” (ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ)"
          fi
          
          # Slack ë©”ì‹œì§€ ìƒì„±
          cat > slack_message.json << EOF
          {
            "text": "ğŸ”’ Kubernetes ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ - ${COMPONENT}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ì»´í¬ë„ŒíŠ¸:* ${COMPONENT}"
                  },
                  {
                    "type": "mrkdwn", 
                    "text": "*ë°œê²¬ëœ ì´ìŠˆ:* ${ISSUE_COUNT}ê°œ"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ìŠ¤ìº” ëª¨ë“œ:* ${SCAN_MODE_TEXT}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ì‹¤í–‰ ì‹œê°„:* $(date '+%Y-%m-%d %H:%M')"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸ“‹ *ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ*\në³´ì•ˆ ì´ìŠˆ ${ISSUE_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒì„¸ ë¶„ì„ ê²°ê³¼ëŠ” GitHub Actionsì—ì„œ í™•ì¸í•˜ì„¸ìš”."
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ì›Œí¬í”Œë¡œìš° ë³´ê¸°"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
          EOF
          
          # Slack ì›¹í›…ìœ¼ë¡œ ì „ì†¡
          if curl -X POST -H 'Content-type: application/json' \
            --data @slack_message.json \
            "$SLACK_WEBHOOK_URL"; then
            echo "âœ… Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
          else
            echo "âŒ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          fi

      # SARIF ì—…ë¡œë“œ (í¬í¬ PRì´ ì•„ë‹Œ ê²½ìš°)
      - name: Upload SARIF to GitHub Security
        if: |
          always() && (github.event_name != 'pull_request' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false))
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results/${{ matrix.name }}.sarif
          category: checkov-${{ matrix.name }}
        continue-on-error: true

      # SARIF íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ (ë°±ì—…)
      - name: Upload SARIF as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sarif-${{ matrix.name }}
          path: results/${{ matrix.name }}.sarif
          if-no-files-found: warn
          retention-days: 30

      # JSON ê²°ê³¼ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload JSON results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: json-results-${{ matrix.name }}
          path: results/${{ matrix.name }}.json
          if-no-files-found: warn
          retention-days: 30

  # ìŠ¤ìº” ì™„ë£Œ ìš”ì•½
  summary:
    needs: [detect, scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Scan summary
        run: |
          echo "## ğŸ”’ Checkov ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
          echo ""
          echo "**ìŠ¤ìº” ëª¨ë“œ**: ${{ needs.detect.outputs.scan_mode }}"
          
          if [ "${{ needs.detect.outputs.scan_mode }}" = "full_scan" ]; then
            echo "**ì‹¤í–‰ ì´ìœ **: ì›Œí¬í”Œë¡œ íŒŒì¼ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ì „ì²´ ìŠ¤ìº”"
          elif [ "${{ needs.detect.outputs.scan_mode }}" = "changed_scan" ]; then
            echo "**ì‹¤í–‰ ì´ìœ **: ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”"
          else
            echo "**ì‹¤í–‰ ì´ìœ **: ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
          
          echo ""
          echo "**ìŠ¤ìº” ê²°ê³¼**: ${{ needs.scan.result }}"
          echo "**ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ìƒì„¸ ê²°ê³¼ëŠ” ê° ì»´í¬ë„ŒíŠ¸ë³„ ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
