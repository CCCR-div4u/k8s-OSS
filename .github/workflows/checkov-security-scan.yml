name: Checkov

on:
  push:
  pull_request:

permissions:
  contents: read
  security-events: write  # SARIF 업로드에 필요

jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Checkov 실행 (K8s/Helm/Dockerfile 대상)
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: kubernetes,helm,dockerfile
          quiet: true
          output_format: sarif
          output_file_path: results.sarif
          soft_fail: false           # 실패 시 빌드 차단 (초기엔 .checkov.yaml로 완화 가능)

      # 결과를 GitHub Code Scanning으로 업로드
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
