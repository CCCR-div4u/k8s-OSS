apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-bench-auto-remediation
  namespace: kagent
  labels:
    app: kube-bench-remediator
    component: auto-scan
spec:
  # ë§¤ì¼ ì˜¤ì „ 10ì‹œ (KST ê¸°ì¤€ ì˜¤ì „ 1ì‹œ UTC)ì— ì‹¤í–‰
  schedule: "0 1 * * *"
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app: kube-bench-remediator
        component: auto-scan
    spec:
      template:
        metadata:
          labels:
            app: kube-bench-remediator
            component: auto-scan
        spec:
          serviceAccountName: kube-bench-remediator
          restartPolicy: OnFailure
          containers:
          - name: auto-remediation
            image: curlimages/curl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "ğŸ” Starting automatic kube-bench remediation..."
              
              # kagent API í˜¸ì¶œì„ í†µí•œ ìë™ ìŠ¤ìº” ì‹¤í–‰
              # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” kagent API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©
              
              KAGENT_API_URL="http://kagent-api.kagent.svc.cluster.local:8080"
              AGENT_NAME="kube-bench-remediator"
              
              # ìë™ ìŠ¤ìº” ì‹¤í–‰
              curl -X POST "${KAGENT_API_URL}/api/v1/agents/${AGENT_NAME}/invoke" \
                -H "Content-Type: application/json" \
                -d '{
                  "input": "scan",
                  "metadata": {
                    "source": "cronjob",
                    "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
                    "auto_mode": true
                  }
                }' || echo "âŒ Failed to invoke agent"
              
              echo "âœ… Auto remediation job completed"
            
            env:
            - name: TZ
              value: "Asia/Seoul"
            
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 200m
                memory: 256Mi
                
            volumeMounts:
            - name: config
              mountPath: /etc/kube-bench-remediator
              readOnly: true
              
          volumes:
          - name: config
            configMap:
              name: kube-bench-remediator-config

---
# ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ Job í…œí”Œë¦¿
apiVersion: batch/v1
kind: Job
metadata:
  name: kube-bench-manual-remediation
  namespace: kagent
  labels:
    app: kube-bench-remediator
    component: manual-scan
spec:
  template:
    metadata:
      labels:
        app: kube-bench-remediator
        component: manual-scan
    spec:
      serviceAccountName: kube-bench-remediator
      restartPolicy: Never
      containers:
      - name: manual-remediation
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "ğŸ” Starting manual kube-bench remediation..."
          echo "Mode: ${REMEDIATION_MODE:-scan}"
          echo "Targets: ${TARGET_NAMESPACES:-default}"
          echo "Approve: ${APPROVE:-false}"
          
          KAGENT_API_URL="http://kagent-api.kagent.svc.cluster.local:8080"
          AGENT_NAME="kube-bench-remediator"
          
          # ì…ë ¥ ëª…ë ¹ì–´ êµ¬ì„±
          INPUT_COMMAND="${REMEDIATION_MODE:-scan}"
          if [ -n "$TARGET_NAMESPACES" ]; then
            INPUT_COMMAND="$INPUT_COMMAND targets.namespaces=$TARGET_NAMESPACES"
          fi
          if [ "$APPROVE" = "true" ]; then
            INPUT_COMMAND="$INPUT_COMMAND approve=true"
          fi
          
          # ì—ì´ì „íŠ¸ í˜¸ì¶œ
          curl -X POST "${KAGENT_API_URL}/api/v1/agents/${AGENT_NAME}/invoke" \
            -H "Content-Type: application/json" \
            -d '{
              "input": "'"$INPUT_COMMAND"'",
              "metadata": {
                "source": "manual-job",
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
                "user": "'"${USER:-system}"'"
              }
            }' || echo "âŒ Failed to invoke agent"
          
          echo "âœ… Manual remediation job completed"
        
        env:
        - name: REMEDIATION_MODE
          value: "scan"  # scan, plan, apply
        - name: TARGET_NAMESPACES
          value: "default"
        - name: APPROVE
          value: "false"
        - name: USER
          value: "admin"
        - name: TZ
          value: "Asia/Seoul"
        
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
            
        volumeMounts:
        - name: config
          mountPath: /etc/kube-bench-remediator
          readOnly: true
          
      volumes:
      - name: config
        configMap:
          name: kube-bench-remediator-config
