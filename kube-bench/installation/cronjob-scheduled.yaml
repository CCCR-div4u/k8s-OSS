apiVersion: batch/v1
kind: CronJob
metadata:
  name: kube-bench-scheduled-audit
  namespace: default
  labels:
    app: kube-bench
    type: scheduled-audit
spec:
  # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 2ì‹œ ì‹¤í–‰
  schedule: "0 2 * * 0"
  
  # ìµœëŒ€ 3ê°œì˜ ì„±ê³µí•œ Job ê¸°ë¡ ë³´ê´€
  successfulJobsHistoryLimit: 3
  
  # ìµœëŒ€ 1ê°œì˜ ì‹¤íŒ¨í•œ Job ê¸°ë¡ ë³´ê´€
  failedJobsHistoryLimit: 1
  
  # ë™ì‹œ ì‹¤í–‰ ë°©ì§€
  concurrencyPolicy: Forbid
  
  # Job ì‹œì‘ ë°ë“œë¼ì¸ (10ë¶„)
  startingDeadlineSeconds: 600
  
  jobTemplate:
    spec:
      # Job ì™„ë£Œ í›„ 1ì‹œê°„ ë’¤ ìë™ ì •ë¦¬
      ttlSecondsAfterFinished: 3600
      
      template:
        metadata:
          labels:
            app: kube-bench
            type: scheduled-audit
        spec:
          restartPolicy: Never
          hostPID: true
          
          tolerations:
          - operator: Exists
          
          containers:
          - name: kube-bench-scheduler
            image: aquasec/kube-bench:latest
            command: ["/bin/sh"]
            args:
            - -c
            - |
              echo "ğŸ• Starting scheduled security audit at $(date)"
              
              # ê²°ê³¼ ì €ì¥ ë””ë ‰í„°ë¦¬ ìƒì„±
              TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
              RESULT_DIR="/tmp/kube-bench-$TIMESTAMP"
              mkdir -p $RESULT_DIR
              
              # EKS í™˜ê²½ ê°ì§€
              if kubectl get configmap -n kube-system aws-auth &>/dev/null; then
                echo "ğŸ” EKS environment detected"
                kube-bench --benchmark eks-1.2.0 --json > $RESULT_DIR/eks-audit.json
                kube-bench --benchmark eks-1.2.0 > $RESULT_DIR/eks-audit.txt
              else
                echo "ğŸ” Standard Kubernetes environment detected"
                kube-bench --targets master,node --json > $RESULT_DIR/k8s-audit.json
                kube-bench --targets master,node > $RESULT_DIR/k8s-audit.txt
              fi
              
              # ê²°ê³¼ ìš”ì•½ ìƒì„±
              echo "ğŸ“Š Generating audit summary..."
              cat > $RESULT_DIR/summary.md << EOF
              # Kube-bench Security Audit Report
              
              **Date**: $(date)
              **Cluster**: $CLUSTER_NAME
              **Node**: $NODE_NAME
              
              ## Summary
              EOF
              
              # í†µê³„ ê³„ì‚°
              for file in $RESULT_DIR/*.txt; do
                if [ -f "$file" ]; then
                  PASS_COUNT=$(grep -c "\[PASS\]" "$file" 2>/dev/null || echo "0")
                  FAIL_COUNT=$(grep -c "\[FAIL\]" "$file" 2>/dev/null || echo "0")
                  WARN_COUNT=$(grep -c "\[WARN\]" "$file" 2>/dev/null || echo "0")
                  
                  echo "### $(basename $file .txt)" >> $RESULT_DIR/summary.md
                  echo "- âœ… PASS: $PASS_COUNT" >> $RESULT_DIR/summary.md
                  echo "- âŒ FAIL: $FAIL_COUNT" >> $RESULT_DIR/summary.md
                  echo "- âš ï¸ WARN: $WARN_COUNT" >> $RESULT_DIR/summary.md
                  echo "" >> $RESULT_DIR/summary.md
                fi
              done
              
              # ì‹¤íŒ¨í•œ ê²€ì‚¬ í•­ëª© ì¶”ê°€
              echo "## Failed Checks" >> $RESULT_DIR/summary.md
              for file in $RESULT_DIR/*.txt; do
                if [ -f "$file" ]; then
                  grep "\[FAIL\]" "$file" | head -10 >> $RESULT_DIR/summary.md
                fi
              done
              
              echo "âœ… Scheduled audit completed successfully"
              echo "ğŸ“ Results saved to: $RESULT_DIR"
              
              # ê²°ê³¼ë¥¼ ConfigMapìœ¼ë¡œ ì €ì¥ (ì„ íƒì‚¬í•­)
              if [ "$SAVE_TO_CONFIGMAP" = "true" ]; then
                kubectl create configmap kube-bench-results-$TIMESTAMP \
                  --from-file=$RESULT_DIR/ \
                  --dry-run=client -o yaml | kubectl apply -f -
                echo "ğŸ’¾ Results saved to ConfigMap: kube-bench-results-$TIMESTAMP"
              fi
            
            env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: CLUSTER_NAME
              value: "my-eks-cluster"  # í´ëŸ¬ìŠ¤í„°ëª…ìœ¼ë¡œ ë³€ê²½
            - name: SAVE_TO_CONFIGMAP
              value: "false"  # ConfigMap ì €ì¥ ì—¬ë¶€
            
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi
            
            volumeMounts:
            - name: var-lib-kubelet
              mountPath: /var/lib/kubelet
              readOnly: true
            - name: etc-kubernetes
              mountPath: /etc/kubernetes
              readOnly: true
            - name: usr-bin
              mountPath: /usr/local/mount-from-host/bin
              readOnly: true
          
          volumes:
          - name: var-lib-kubelet
            hostPath:
              path: "/var/lib/kubelet"
          - name: etc-kubernetes
            hostPath:
              path: "/etc/kubernetes"
          - name: usr-bin
            hostPath:
              path: "/usr/bin"